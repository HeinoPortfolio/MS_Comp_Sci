---
title: "Crime Rate and Unemployment Rate"
author: "Matthew E. Heino"
date: "`r Sys.Date()`"
link-citations: yes
output:
  bookdown::html_document2

---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning= FALSE, 
                      fig.align= "center")

```

Load the required modules for the project

```{r lib_load }

library(tidyverse)
library(raster)          
library(sf)              
library(ggspatial)       
library(ggnewscale)     
library(ggsn)            
#library(shiny)           
library(plotly)          
#library(gridExtra)       

```

Set the working directory

```{r set-dir}

setwd(dirname(rstudioapi::getSourceEditorContext()$path))

```

# Crime Rate and Unemployment Rate {-}

# Data {#data-descr}

The data used was for this analysis is from three files.  Each File contained data that needed to be joined in to a  single coherent data frame that contained all the relevant information.  The three files are the following:

<br>

- 1) **crime_and_incarceration_by_state.csv** - holds information about crime statistics for each state and other data.  It is composed of 18 different variables.  Only a few will be used in the analysis.  They are listed below. Variables, violent_crime_total and state_population, will be used to calculate the crime rate.  The calculation can be found in Section: \@ref(calc-crime). "jurisdiction" and "year" column names will be changed in Section: \@ref(proc-crime). Additional information about the processing can be found in subsequent sections.

      The features that will be used from the file are:

      * Variable 1: **violent_crime_total** - the total amount of violent crime in the state
      * Variable 2: **state_population** - the total population of the state
      * Variable 3: **jurisdiction** - holds the state name.
      * Variable 4: **year** - holds the year the data was recorded

<br>

- 2) **unemployment_county.csv** - This data will be processed in Section: \@ref(unempl). Additional information will be found in this section.

      The features that will be used from the file are:

      * Variable 1: **Employed** - the number of people employed in each of the counties
      * Variable 2: **Unemployed** - the number of people unemployed in each of the counties
      * Variable 3: **Unemployment Rate** - the unemployment rate for each of the counties 

<br>

- 3) **tl_2019_us_state.shp** -  this is the shape file that will be used in the mapping the data in Sections: \@ref(unempUSA) and \@ref(crimeUSA)

<br>
**Note**: All other columns will not be used and will discarded during further processing. 


# Project Objectives


# Data Processing and Data Visualization

## Data preprocessing:  {-}

Steps: 

  * Read the data from the CSV files into individual data frames.  **Section**: \@ref(read-data) .
  * Remove the parts of the United States that are not contiguous. **Section**: \@ref(remove-parts) .
  * Process the unemployment rate data. **Section**: \@ref(unempl)
  * Process the crime rate data.   **Section**: \@ref(proc-crime)
  * Join relational tables. **Section**: \@ref(join-tbl)
  * Save the final combined and cleaned data. **Section**: \@ref(save-file)

### Read in the data from the data files. {#read-data}

This code will read in data from the data files that were discussed in **Section** \@ref(data-descr)

```{r read-data-files, results= FALSE}

# Read in the unemployment rate from the CSV file
Unemployrate <-  read_csv("data/unemployment_county.csv")

# Read in the Crime rate from the CSV file
Crimerate <- read_csv ("data/crime_and_incarceration_by_state.csv")

# Read the states shape file
States <- st_read("data/tl_2019_us_state/tl_2019_us_state.shp")

```


### Remove the parts of the United States that are not contiguous.  {#remove-parts}

The states of Alaska, American Samoa, Northern Mariana Islands, Puerto Rico, US Virgin Islands, Hawaii, and Guam.  The projects analysis will only focus on the contiguous United States or the mainland United States.  Analysis will focus on the lower 48 states. 


```{r remove_parts }

Contiguous_state <- States %>% filter(STUSPS != "AK" & STUSPS != "AS" &
                                        STUSPS != "MP" & STUSPS != "PR" &
                                        STUSPS != "VI" & STUSPS != "HI" &
                                        STUSPS != "GU")

```

### Process the unemployment rate data {#unempl}

The data will be filtered to remove Alaska and Hawaii from the data set.  This analysis will only focus on the contiguous United States. It is not needed so it will be removed from the data.  The data will be grouped by state and then by the Year in which the data was collected. Three variables will created. These variables are the following:

  - **TotalForce**: This variable will hold the total number of workers.  This includes all workers both employed and                                          unemployed.
  - **Totalemployed**: This variable will hold the total number of employed workers.
  - **Totalunemployed**: This variable will hold the total number of unemployed workers.
  - **Meanrate**: This variable will hold the mean rate of unemployment

```{r create_new_var}

Unemployrate <- Unemployrate %>% filter(State != 'AK' & State != "HI") %>%
  group_by(State, Year) %>% 
  summarise(Totalforce = sum(`Labor Force`), Totalemployed=sum(Employed),
            Totalunemployed=sum(Unemployed), Meanrate = mean(`Unemployment Rate`,
                                                             rm.na=TRUE))

```

The column in this data frame will need to have a column name changed from "State" to "STUSPS".  The years that will required will be also filtered from the data set.  The years that are required for this project were from 2007 to 2014.

```{r filter-by-year}

Unemployrate <- Unemployrate %>% rename("STUSPS" = "State") %>%
  filter(Year %in% c(2007:2014))

```

### Process the Crime rate {#proc-crime}

In this step the crime rate will need to have two columns renamed using the **rename()** function.  The two columns are jurisdiction and the year columns. The "jurisdiction" column will be changed to "STUSPS".  This will aid joining the frames in a later step.  Changing "year" to "Year" will help keep the naming convention consistent among the data frames that are to be used in the final project.   

```{r rename_crime}

Crimerate <- Crimerate %>% 
  rename("STUSPS" = "jurisdiction") %>%
  rename("Year" = "year") %>%
  filter(STUSPS != "FEDERAL" & STUSPS != "ALASKA" & STUSPS != "HAWAII") %>%
  filter(Year %in% c(2007:2014))

```

There will be a need to change the state names in the STUSPS column.

```{r change_state}

Crimerate$STUSPS <- state.abb[match(str_to_title(Crimerate$STUSPS), state.name)]

```

### Calculate the crime rate {#calc-crime}

The crime rate was calculated using two columns from the Crimerate data frame. The columns were:

  - **violent_crime_total**: the total number of violent crime in the state
  - **state_population**:  the population of the state

```{r calc-crime-rate}

Crimerate <- Crimerate %>% 
  mutate(Crimerate=(violent_crime_total/state_population) * 100) %>%
  dplyr::mutate_if(is.numeric, round, 1)

```

### Join relational tables {#join-tbl}

The data frames will be joined so all the data will be contained in one frame. Only unique columns will be included within the final data frame. From the joined data frames select columns that are relevant for final use in the creation of the final project.  

```{r join_frames}

CS_Erate <- right_join(Contiguous_state, Unemployrate, by= c("STUSPS"))

CS_Erate_Crate <- right_join(CS_Erate, Crimerate, by= c("STUSPS", "Year"))

CS_Erate_Crate1 <- CS_Erate_Crate %>% 
  select(REGION, STUSPS, NAME, Year, Meanrate,Crimerate) %>% 
  rename("Unemplyrate"="Meanrate")

```

### Save the final combined and cleaned data. {#save-file}

```{r save-data}

saveRDS(CS_Erate_Crate1, file = "CS_Erate_CrateCombined1.Rds")

```

## EDA analysis

```{r eda-analysis}

# Create a copy of the data frame
stats_df <- data.frame(CS_Erate_Crate1) %>% select(-geometry)
#stats_df <- CS_Erate_Crate1 %>% select(-geometry)


#head(stats_df_new)

#summary(stats_df)
#summary(stats_df[c('Unemplyrate', 'Crimerate')])

# grouped stats
#tapply(stats_df$Unemplyrate, stats_df$REGION, summary) 

#tapply(stats_df$Unemplyrate, stats_df$Year, summary)


region_unemploy <- stats_df %>%
group_by(REGION) %>%
  summarise(
    `Region Mean` = mean(Unemplyrate),
    `Maximum Unemployment Rate` = max(Unemplyrate),
    `Minimum Unemployment Rate` = min(Unemplyrate)
  )


knitr::kable(region_unemploy, caption = "Regional Unemployment Statistics.", align = "cccc")
 
```

```{r}

region_year_unemploy <-stats_df %>%
group_by(Year, REGION) %>%
  summarise(
    `Mean of the Region` = mean(Unemplyrate),
    `Maximum Unemployment Rate` = max(Unemplyrate),
    `Minimum Unemployment Rate` = min(Unemplyrate)
  )

knitr::kable(region_year_unemploy, caption = "Regional Unemployment Statistics by Year.", align = "cccc")

```

## Data analytics method 

The data visualizations that were produced for the project were the following:

  * A spatial map over the contiguous USA for the unemployment rate for the specific year 2014.
  * A spatial map over the contiguous USA for the crime rate for the specific year 2014.
  * Scatter plot for the data relationship between the unemployment rate and crime rate.
  * Time series plot for the four states for the unemployment rate
  * Time series plot for the four states for the crime rate
  
Data for the creation of the graphs is loaded from the RDS file that was created in a previous section of the project. The file is a ".Rds" the name of the file is:

  - **CS_Erate_CrateCombined1.Rds**
  
This file will read in using the **readRDS()**.  The data found in this will then be used to create the plots that are found in this section of the project.

Read the cleaned data from the ".Rds" file.

```{r read-combined}

all_info_from_RDS <- readRDS("CS_Erate_CrateCombined1.Rds")

```


### A spatial map over the contiguous USA for the unemployment rate for the specific year 2014. {#unempUSA}

This is a map of the unemployment rate for the year 2014. This will be an interactive plot using the **plot_ly** function to create it. 

The only year that will plotted on this time series plot will be for the year 2014.  This data will be filtered from the **all_info_from_RDS**.

**Note**:  This step could have been done using a pipe, but this makes it easier to see what is going on.

```{r}

info_for_year_2014 <- all_info_from_RDS %>% filter(all_info_from_RDS$Year == 2014)

```

Using the **info_for_year_2014** data frame a graph of the contiguous United States will be created showing unemployment rate as a layer on the graph.

```{r sp-unemp, fig.cap= "A spatial map over the contiguous USA for the unemployment rate for the year 2014", fig.height=7, fig.width=10}

ggplot(data=info_for_year_2014) + 
  geom_sf(data= info_for_year_2014$geometry, 
          aes(fill=info_for_year_2014$Unemplyrate)) + 
  xlab("Longitude") +
  ylab("Latitude") +
  guides(fill=guide_legend(title= "Unemployment Rate for 2014")) + 
  labs(title = "Unemployment Rate Over Contiguous USA ",
       subtitle = "Unemployment Color Coded by State",
       caption = "Data source: Unknown") +
  scalebar(data= info_for_year_2014, location="bottomleft", dist= 500, st.size=2,
           dist_unit = "km", transform= TRUE, model= "WGS84", st.dist=0.04) +
  annotation_north_arrow(location = "br", which_north = "true", 
                         style = north_arrow_fancy_orienteering) +
  theme(panel.background = element_blank())

```


### A spatial map over the contiguous USA for the crime rate for the specific year 2014. {#crimeUSA}

Using the **info_for_year_2014** data frame a graph of the contiguous United States will be created showing crime rate as a layer on the graph.

```{r sp-crime, fig.cap="Spatial map over the contiguous USA for the crime rate for the year 2014", fig.height=7, fig.width=10}

ggplot(data=info_for_year_2014) + 
  geom_sf(data= info_for_year_2014$geometry, 
          aes(fill=info_for_year_2014$Crimerate)) + 
  xlab("Longitude") +
  ylab("Latitude") +
  guides(fill=guide_legend(title= "Crime Rate for 2014")) + 
  labs(title = "Crime Rate Over Contiguous USA ",
       subtitle = "Crime Rate Color Coded by State",
       caption = "Data source: Unknown") + 
  scalebar(data= info_for_year_2014, location="bottomleft", dist= 500, st.size=2,
           dist_unit = "km", transform= TRUE, model= "WGS84", st.dist=0.04) +
  annotation_north_arrow(location = "br", which_north = "true", 
                         style = north_arrow_fancy_orienteering) +
  theme(panel.background = element_blank())

```


### Scatter plot for the data relationship between the unemployment rate and crime rate. {-}

Creates a scatter plot using crime rate (x-axis) and unemployment rate (y-axis).

```{r scatter-un-cr, fig.cap="Scatter plot for the data relationship between the unemployment rate and crime rate", fig.height=7, fig.width=10}

fig <- plot_ly(data= info_for_year_2014, x= ~Crimerate, y= ~Unemplyrate,
                color= ~REGION) %>%
  add_markers() %>%
  layout(title="Unemployment Rate and Crime Rate for 2014",  
         xaxis=list(title= "Crime Rate Per 100,000 People"),
         yaxis=list(title="Unemployment Rate Per 100 People"),
         legend=list(title=list(text='<b> Region </b>'), showlegend=TRUE))
  
fig

```

### 4) Time series plot for the four states for the unemployment rate. {-}

This will be an interactive plot of the unemployment rate for four states:

  - California
  - Idaho
  - Illinois
  - Indiana
  
Steps to create the time series plot:
  
  * Data will be filtered from the **all_info_from_RDS** data frame and a new data frame will be created. **Section**: \@ref(four-sta)
  * The new data frame created is four_states_year_2014. **Section**: \@ref(four-sta)
  * Create the unemployment rate time series plot. **Section**: \@ref(ts-unemp)
  * Create the crime rate time series plot.**Section**: \@ref(ts-cri)

Section \@ref(four-sta) data filtered from the **all_info_from_RDS** data frame and a new data frame will be created. A vector of states was created to form the list of states that were to plotted on the graph.  These states will be used for this time series plot and the one that follows.

## Data will be filtered from the all_info_from_RDS data frame and a new data frame will be created. {#four-sta}
```{r four-states, fig.cap=""}

states <- c("California", "Idaho", "Illinois", "Indiana") 
four_states_year_2014 <- all_info_from_RDS %>% filter(NAME %in% states)

stats_df <-  as.data.frame(four_states_year_2014)

```

## Create the unemployment rate time series plot. {#ts-unemp}

```{r plotly-unemployment-rate, fig.cap= "Unemployment rate time series plot."}

une <- plot_ly(data=stats_df, x= ~as.factor(Year), y= ~Unemplyrate,color= ~NAME) %>%
  filter(NAME %in% states) %>%
  group_by(NAME) %>%
  add_lines() %>%
  layout(title="Unemployment Rate Changes by Year",  
         xaxis=list(title= "Year"),
         yaxis=list(title="Unemployment Rate"), 
         legend=list(title=list(text='<b> State </b>'), showlegend=TRUE))

une  

```

## Create the crime rate time series plot. {#ts-cri}

**Note**: To better see the crime rate for California select it from the legend on the right of the plot.

```{r plotly-crime-rate, fig.cap= "Crime rate time series plot."}

cr <- plot_ly(data=stats_df, x= ~as.factor(Year), y= ~Crimerate, color= ~NAME) %>%
  filter(NAME %in% states) %>%
  group_by(NAME) %>%
  add_lines() %>%
  layout(title="Crime Rate Changes by Year",  
         xaxis=list(title= "Year"),
         yaxis=list(title="Crime Rate"), yaxis=list(range(c(0, .7))),
         legend=list(title=list(text='<b> State </b>'), showlegend=TRUE))

  
cr
```

# 4 Discussion and conclusion {-}


(See "Spatial unemployment" Figure \@ref(fig:sp-unemp))

(See "Spatial crime" Figure \@ref(fig:sp-crime))
 
(See "Scatter" Figure \@ref(fig:scatter-un-cr))
 
(See "Crime rate" Figure \@ref(fig:plotly-crime-rate))

(See "Unemployment Rate" Figure \@ref(fig:plotly-unemployment-rate))

# 5 References {-}

[List all references articles you refer for the final project]

